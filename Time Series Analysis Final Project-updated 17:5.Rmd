---
title: "Time Series Analysis Final Project"
author: "Yu-Jin Bae (s3872886), Yichen Zhu and Ting Li (s3912985)"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
rm(list=ls())
```

# 1. Introduction

[To be updated]


# 2. Preparation

### 2.1 Importing a dataset

```{r}
setwd("/Users/momo/Documents/Master of Analytics/SEM1 2022/Time Series Analysis")
sea <- read.csv("sealevel.csv", skip = 6)

head(sea)
```

### 2.2 Loading required libraries

```{r}
library(TSA)
library(lmtest)
#library(fUnitRoots)
library(tseries)
```

### 2.3 Creating a time series object

```{r}

colnames(sea) <- c('Year','sea_level(inches)') # assigning new column names for simplicity
sea_ts <- ts(as.vector(sea$`sea_level(inches)`),start=1880, end=2013)
             # As this is an annual dataset, the frequency of series is 1
class(sea_ts)

sea_ts
```

# 3. Data visualisation and descriptive analysis

### 3.1 Descriptive analysis

- **Trend**: while some years have seen a slight decrease, it broadly displays an upward trend. <br />
- **Seasonality**: no clear seasonality component is observed in this plot. <br />
- **Changing variance**: there is neither obvious changing variance nor fluctuation.  <br />
- **Behaviour**: succeeding observations suggest an autoregressive behaviour rather than a moving average behaviour. <br />
- **Change point**: for the observed period, there appears to be no intervention or obvious change point. 

```{r}
plot(sea_ts,type='o',ylab="Sea level (in inches)", main='Figure 1: Original time series plot of sea level')
```
<br />

### 3.2 Summary Statistics

There is a large variation between the minimum value (-0.4409) and the maximum value (9.4793) as demonstrated in Figure 1. The summary statistics result suggests that while the highest sea level is 9.4793, the sea level for 50% of the observations are less than 3.5807 and 75% of the observations are less than 5.8888, which is visually corroborated by Figure 2. The summary statistics result, Figure 1 and Figure 2 collectively indicate that the sea level is below 5.888 approximately for most years during the observed period.

```{r}
summary(sea_ts)
hist(sea_ts, main='Figure 2: Histogram of sea level', col="light blue", xlab="sea level (inches)",xlim = range(-2,12,1), ylim=range(0,30,5))
```
<br />

### 3.3 Analysing autocorrelation plots

- ACF: The ACF plot shows a slowly decaying pattern in the ACF plot, which indicates non-stationarity. <br />
- PACF: The sea level time series appears to be non-stationary as the only significant autocorrelation is identified at lag 1. <br />
```{r}
par(mfrow=c(2,1))
acf(sea_ts, main ="Figure 3: ACF plot of sea level time series data")
pacf(sea_ts, main ="Figure 4: PACF plot of sea level time series data")
```
<br />

# 4. Model fitting

Two different models (linear and quadratic) will be fitted to the sea level time series data to find the best fitting model for forecasting. Cyclical/seasonal and cosine wave/harmonic trend models will not be used for fitting as the data does not display any seasonal or harmonic trends. 

### 4.1.1 Linear model fitting

The model is significant as the p-value is less than 0.05 (i.e. < 2.2e-16). The adjusted R-squared value is 0.9703 which suggests that the best fit line passes through the majority of data points in the regression model.
```{r}
model1 = lm(sea_ts~time(sea_ts)) 
summary(model1)
```
Based on Figure 5, the linear trend model appears to fit quite well to the sea level time series. However, some data points are not being captured. 

```{r}
plot(sea_ts,type='o',ylab='sea level (inches)', main="Figure 5: Time series plot of sea level and fitted linear trend model")
abline(model1, col="red")
```
<br />

### 4.1.2 Linear model fitting - residual analysis

- Standardised residuals: The standardised residuals range between -1 and 3 which is acceptable and random pattern can be identified. <br />
- Histogram: The histogram lies between -2 and 3, and most of the residuals lie between -1 and 1 which is acceptable. However, the histogram is slightly right-skewed. <br />
- QQ plot: Departures are observed for some dots from the reference line. <br /> 
- ACF plot: Most bars are not within the limits which means the ACF plot does not adequately capture the information in the series so well, which is not ideal. <br />
- Shapiro-Wilk normality test: Shapiro-Wilk normality test suggests with 95% confidence that the sea level time series data does not fit the normal distribution under the linear trend model as p-value is less than 0.05.

```{r}
#Creating a function to plot time series plot, histogram, QQ plot and ACF plot of residuals and Shapiro-Wilk test for residuals at once instead of having to repeat the same chunk of code for each model

residual.analysis <- function(model){  
  res.model = rstandard(model)
  par(mfrow=c(3,2))
  plot(res.model,type='o',ylab='Standardised residuals', main="Time series plot of standardised residuals")
  hist(res.model,main="Histogram of standardised residuals")
  qqnorm(res.model,main="QQ plot of standardised residuals")
  qqline(res.model, col = 2)
  acf(res.model,main="ACF of standardised residuals")
  pacf(res.model,main="PACF of standardised residuals")
  print(shapiro.test(res.model))  
  par(mfrow=c(1,1))
}
residual.analysis(model1)
```
<br />

### 4.2.1 Quadratic model fitting

The model is significant as the p-value is less than 0.05 (i.e. < 2.2e-16). The adjusted R-squared value (i.e. 0.9904) for the quadratic model is higher than it is for the linear model which means the best fit line for the quadratic model passes through more data points than the linear model best fit line does.
```{r}
t = time(sea_ts)
t2 = t^2
model2 = lm(sea_ts ~ t + t2) # label the quadratic trend model as model2
summary(model2)
```


```{r}
plot(ts(fitted(model2)), ylim = c(min(c(fitted(model2), as.vector(sea_ts))), max(c(fitted(model2),as.vector(sea_ts)))),ylab='sea level (inches)',
     main = "Figure 6: Time series plot of sea level and fitted quadratic trend model", col="red")
lines(as.vector(sea_ts),type="o")
```
<br />

### 4.2.2 Quadratic model fitting - residual analysis

- Standardised residuals: The standardised residuals range between -3 and 3 which is acceptable and random pattern can be identified. <br />
- Histogram: The histogram lies between -3 and 3, and most of the residuals lie between -1 and 1 which is acceptable. The histogram appears to be constructed on values that are normally distributed as it forms a symmetrical bell shape. <br />
- QQ plot: Most dots are fitted to the reference line with some departures. <br /> 
- ACF plot: Some of the bars are not within the limits which suggests that  the ACF plot does not adequately capture the information in the series so well. <br />
- Shapiro-Wilk normality test: Shapiro-Wilk normality test suggests with 95% confidence that the sea level time series data fits the normal distribution under the quadratic trend model as p-value is greater than 0.05.

```{r}
residual.analysis(model2)
```
<br />

### 4.3 Model evaluation using information criterion statistics

Both AIC and BIC suggest that model 2 is better than model 1. 
```{r}
AIC(model1,model2)
BIC(model1,model2)
```


### 4.4 Model fitting result

The sea level time series data fits the normal distribution under the quadratic trend model and the quadratic trend model captures the trend better than the linear model does. However, it is unable to adequately capture the autocorrelation. Therefore, ARIMA model will be used in the later section.

# 5. Preparation for ARIMA modelling

### 5.1 Stationarity test

The null hypothesis stating that the series is non-stationary cannot be rejected as the p-value is higher than 0.05 for the ADF test and the Phillips-Perron Unit Root Test, and the p-value is lower than 0.05 for KPSS Test for Level Stationarity. The results from three stationarity tests are consistent with the observations from the ACF and PACF plots that the series is non-stationary. 

```{r}
#Creating a function for a set of normality test 
stationarity.test <- function(ts){
  print(adf.test(ts))
  print(kpss.test(ts))
  print(pp.test(ts))
}
stationarity.test(sea_ts)
```


### 5.2. Normality test

Both Shapiro-Wilk normality test and One-sample Kolmogorov-Smirnov test results suggest that the sea level time series data does not fit normal distribution as the p-value is less than 0.05. The QQ plot result is also consistent with the result from other normality tests as the departure of most dots from the reference line is observed. 
```{r}
#Creating a function for a set of normality test 
normality.test <- function(ts){
  qqnorm(ts, main = "QQ plot")
  qqline(ts, col = 2)
  print(shapiro.test(ts)) 
  ks.test(ts,"pnorm",0,1)
}
normality.test(sea_ts)
```

### 5.3.1 Transformation - Box-Cox transformation

As trend exists and non-stationarity was detected, Box-Cox transformation and differencing will be applied to detrend the series and remove non-stationarity. 
```{r error=TRUE}

data.sea <- sea_ts + abs(min(sea_ts)) + 0.01 # adding a constant for negative values
BC = BoxCox.ar(data.sea, lambda = seq(-1, 0.1, 0.01))
BC$ci # Values of the first and third vertical lines
lambda <- BC$lambda[which(max(BC$loglike) == BC$loglike)]
lambda # This is the lambda value of the middle vertical line
BC.data.sea = (data.sea^lambda-1)/lambda # Applying Box-Cox transformation
plot(BC.data.sea,type='o',ylab='Transformed sea level',main='Figure 7: BC transformed sea level series')
```

### 5.3.2 Normality & stationarity test on the BC transformed series

Non-stationarity improved but Shapiro-Wilk normality test suggests that normality is worse after box-cox transformation. Therefore, differencing will be applied on the original time series in the next section.
```{r}
normality.test(BC.data.sea)
adf.test(BC.data.sea)
```

### 5.4.1 Transformation - first differencing
The first differenced series appears to be more stationary than the origianal series. There is no trend and the variance is constant over time.

```{r}
diff.data.sea = diff(sea_ts)
plot(diff.data.sea,type='o',ylab='First difference of the sea level',main='Figure 8: First differenced sea level series')
```

### 5.4.2 ACF/PACF after first differencing
One significant autocorrelation is observed at lag 1 from the ACF plot and two significant correlations are observed from lag 1 and lag 2 from the PACF plot. 

```{r}
par(mfrow=c(2,1))
acf(diff.data.sea, main ="Figure 9: ACF plot after first differencing")
pacf(diff.data.sea, main ="Figure 10: PACF plot after first differencing")
```

### 5.4.3 Normality & stationarity test on the first differenced series 
The Shapiro-Wilk normality test suggests that the first differenced series now fits the normal distribution and the null hypothesis stating that the series is non-stationarity can be rejected with a p-value less than 0.05 from the ADF test result and the Phillips-Perron Unit Root Test result. The p-value of 0.1 from the KPSS Test for Level Stationarity also suggests that the series is stationary.
```{r}
normality.test(diff.data.sea)
stationarity.test(diff.data.sea)
```

### 5.5.1 Transformation - second differencing
```{r}
diff.data.sea2 = diff(diff.data.sea, differences = 2)
plot(diff.data.sea2,type='o',ylab='Second difference of the sea level', main='Figure 11: Second difference of sea level series')
```


### 5.5.2 Normality & stationarity test on the second differenced series 

```{r}
normality.test(diff.data.sea2)
stationarity.test(diff.data.sea2)
```

### 5.5.3 ACF/PACF after second differencing
While normality and stationarity has improved (refer to Section 5.5.2 above), the second differencing causes over-differencing as the lag-1 autocorrelation now is more negative than -0.5. 
```{r}
par(mfrow=c(2,1))
acf(diff.data.sea2, main ="Figure 12: ACF plot after second differencing")
pacf(diff.data.sea2, main ="Figure 13: PACF plot after second differencing")
```


### 5.6. Comparison between the original sea level series and the first differenced sea level series
The graphs below clearly show that stationarity was achieved with first differencing which is a desirable property for ARIMA modelling.
```{r}
par(mfrow=c(2,1))
plot(sea_ts,type='o',ylab="Sea level", main='Figure 1: Original time series plot of sea level series')
plot(diff.data.sea,type='o',ylab='First difference of the sea level',main='Figure 8: First differenced sea level series')
```

# 6.Model specification
Since the value of d in the ARIMA model is determined by the order of differencing, we conclude that d=1 for all possible ARIMA models for this dataset. From reading ACF(Fig.9) and PACF plot(Fig.10) we find p=2 and q=1, suggesting an ARIMA(2,1,1). To specify other possible values of p and q, we proceed to model specification with the first difference of the raw time series data (diff.data.sea).


### 6.1 EACF
To find possible values,we look for the top left 0 that is not distracted by x and its neighbouring models in the EACF table. From rows we read possible values for p, and columns for q. To avoid unnecessary over fitting with large p and q values, maximum ar and ma orders are set to 3. 
```{r}
eacf(diff.data.sea, ar.max = 3, ma.max = 3)
#We find {p=0, q=1}, {p=0, q=2}, {p=1, q=1}, {p=1, q=2}, from the top left o and its neighboring models

```

### 6.2 BIC Table
From reading the EACF table, we found ARIMA(0,1,1), ARIMA(0,1,2), ARIMA(1,1,1), ARIMA(1,1,2). To specify more possible model we use the BIC table. Models fitted in the BIC table are displaied in rows with possible values for p from p-lags and q from error-lags. Since the best fitted model is ranked at the top, we read the BIC table from the top row down, looking for p and q values supported by most models and with darker colours. 
```{r}

res = armasubsets(y=diff.data.sea, nar = 3, nma = 3, y.name = "p", ar.method = "ols" )
plot(res)

```
From the BIC table, we found ARIMA(0,1,1) from the best fitted model in the first row, ARIMA (1,1,2) from the second best fitted model in the second row, and ARIMA (1,1,1) from the third best fitted model in the third row. Values p=1, q =1, and q=2 are supported by multiple models fitted in the BIC table.
### 6.3 Possible ARIMA models
Overall, we found ARIMA(0,1,1), ARIMA (0,1,2), ARIMA(1,1,1), ARIMA(1,1,2),  and ARIMA (2,1,1) as possible models for the sea level data, by reading ACF and PACF plot, EACF table, and BIC table. Note that ARIMA(0,1,1), ARIMA(1,1,1), and ARIMA(1,1,2) are supported by more than one model specification tool.

# 7. Parameter Estimation
### 7.1 Model Fitting
All possible ARIMA models are fitted with the CSS and ML method, to determine the best possible model for the time series (sea_ts).
```{r}
#ARIMA(0,1,1)
model_011_css = arima(sea_ts,order=c(0,1,1),method='CSS')
lmtest::coeftest(model_011_css)

model_011_ml = arima(sea_ts,order=c(0,1,1),method='ML')
coeftest(model_011_ml)

#ARIMA(0,1,2)
model_012_css = arima(sea_ts,order=c(0,1,2),method='CSS')
coeftest(model_012_css)

model_012_ml = arima(sea_ts,order=c(0,1,2),method='ML')
coeftest(model_012_ml)

#ARIMA(1,1,1)
model_111_css = arima(sea_ts,order=c(1,1,1),method='CSS')
coeftest(model_111_css)

model_111_ml = arima(sea_ts,order=c(1,1,1),method='ML')
coeftest(model_111_ml)

#ARIMA(1,1,2)
model_112_css = arima(sea_ts,order=c(1,1,2),method='CSS')
coeftest(model_112_css)

model_112_ml = arima(sea_ts,order=c(1,1,2),method='ML')
coeftest(model_112_ml)

model_112_cssml = arima(sea_ts,order=c(1,1,2),method='CSS-ML')
coeftest(model_112_cssml)

#ARIMA(2,1,1)
model_211_css = arima(sea_ts,order=c(2,1,1),method='CSS')
coeftest(model_211_css)

model_211_ml = arima(sea_ts,order=c(2,1,1),method='ML')
coeftest(model_211_ml)

```
### 7.2 AIC and BIC values
Fitted models are sorted based on AIC and BIC values to determine the best model(ranked on top).
```{r}
sort.score <- function(x, score = c("bic", "aic")){
  if (score == "aic"){
    x[with(x, order(AIC)),]
  } else if (score == "bic") {
    x[with(x, order(BIC)),]
  } else {
    warning('score = "x" only accepts valid arguments ("aic","bic")')
  }
}
sort.score(AIC(model_011_ml,model_012_ml,model_111_ml,model_112_ml,model_211_ml), score = "aic")
sort.score(BIC(model_011_ml,model_012_ml,model_111_ml,model_112_ml,model_211_ml), score = "bic" )


```
ARIMA(1,1,2) is selected by both AIC and BIC as the best model for the time series(sea_ts). From ARIMA(1,1,2), we get two over-fitting model, each by increasing p or q by 1, which will be fitted in the following section.

### 7.3 Over-fitting Model 
```{r}

#ARIMA(2,1,2)
model_212_css = arima(sea_ts,order=c(2,1,2),method='CSS')
coeftest(model_212_css)

model_212_ml = arima(sea_ts,order=c(2,1,2),method='ML')
coeftest(model_212_ml)

model_212_cssml = arima(sea_ts,order=c(2,1,2),method='CSS-ML')
coeftest(model_212_cssml)

#ARIMA(1,1,3)
model_113_css = arima(sea_ts,order=c(1,1,3),method='CSS')
coeftest(model_113_css)

model_113_ml = arima(sea_ts,order=c(1,1,3),method='ML')
coeftest(model_113_ml)


#By fitting ARIMA (2,1,2) we found a significant ar2 coefficient
sort.score(AIC(model_011_ml,model_012_ml,model_111_ml,model_112_ml,model_211_ml, model_212_ml), score = "aic")
sort.score(BIC(model_011_ml,model_012_ml,model_111_ml,model_112_ml,model_211_ml, model_212_ml), score = "bic" )
#Over-fitting to check whether ar3 and ma3 would be significant
#ARIMA(3,1,2)
model_312_css = arima(sea_ts,order=c(3,1,2),method='CSS')
coeftest(model_312_css)

model_312_ml = arima(sea_ts,order=c(3,1,2),method='ML')
coeftest(model_312_ml)
#ar3 is insignificant

#ARIMA(2,1,3)
model_213_css = arima(sea_ts,order=c(2,1,3),method='CSS')
coeftest(model_213_css)

model_213_ml = arima(sea_ts,order=c(2,1,3),method='ML')
coeftest(model_213_ml) #we found a significant ma3 coefficient

#model_213_ml is added to sort AIC and BIC scores
sort.score(AIC(model_011_ml,model_012_ml,model_111_ml,model_112_ml,model_211_ml, model_212_ml, model_213_ml), score = "aic")
sort.score(BIC(model_011_ml,model_012_ml,model_111_ml,model_112_ml,model_211_ml, model_212_ml, model_213_ml), score = "bic" )
```
After model-fitting, we proceed to residual check with the best model ARIMA(1,1,2) selected by the BIC table, with the new model ARIMA (2,1,2), as model_212_ml was selected by the AIC table as the best model, and that a significant ar2 coefficient was found from model_212_css.

```{r}
residual.analysis <- function(model, std = TRUE,start = 2, class = c("ARIMA","GARCH","ARMA-GARCH", "fGARCH")[1]){
  library(TSA)
  library(FitAR)
  if (class == "ARIMA"){
    if (std == TRUE){
      res.model = rstandard(model)
    }else{
      res.model = residuals(model)
    }
  }else if (class == "GARCH"){
    res.model = model$residuals[start:model$n.used]
  }else if (class == "ARMA-GARCH"){
    res.model = model@fit$residuals
  }else if (class == "fGARCH"){
    res.model = model@residuals
  }else {
    stop("The argument 'class' must be either 'ARIMA' or 'GARCH' ")
  }
  par(mfrow=c(3,2))
  plot(res.model,type='o',ylab='Standardised residuals', main="Time series plot of standardised residuals")
  abline(h=0)
  hist(res.model,main="Histogram of standardised residuals")
  qqnorm(res.model,main="QQ plot of standardised residuals")
  qqline(res.model, col = 2)
  acf(res.model,main="ACF of standardised residuals")
  print(shapiro.test(res.model))
  k=0
  LBQPlot(res.model, lag.max = 30, StartLag = k + 1, k = 0, SquaredQ = FALSE)
  par(mfrow=c(1,1))
}

residual.analysis(model = model_112_ml)
residual.analysis(model = model_212_css)
residual.analysis(model = model_212_ml)
residual.analysis(model = model_213_ml)

```
